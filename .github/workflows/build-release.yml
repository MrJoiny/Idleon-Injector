name: Build and Release

on:
    workflow_dispatch:

jobs:
    build:
        strategy:
            matrix:
                include:
                    - os: windows-latest
                      artifact-name: InjectCheatsUI-Windows
                      binary-name: InjectCheatsUI.exe
                      build-command: build
                      archive-file: InjectCheatsUI-Windows.zip
                    - os: ubuntu-latest
                      artifact-name: InjectCheatsUI-Linux
                      binary-name: InjectCheatsUI-linux
                      build-command: build-unix
                      archive-file: InjectCheatsUI-Linux.tar.gz
                    - os: macos-15-intel
                      artifact-name: InjectCheatsUI-macOS-x64
                      binary-name: InjectCheatsUI-macos-x64
                      build-command: build-macos-x64
                      archive-file: InjectCheatsUI-macOS-x64.tar.gz
                    - os: macos-15
                      artifact-name: InjectCheatsUI-macOS-arm64
                      binary-name: InjectCheatsUI-macos-arm64
                      build-command: build-macos-arm64
                      archive-file: InjectCheatsUI-macOS-arm64.tar.gz

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install dependencies
              run: npm install

            - name: Install pkg
              run: npm install -g pkg

            - name: Run Validation
              run: npm run validate

            - name: Build Binary
              run: npm run ${{ matrix.build-command }}

            - name: Create release package
              shell: bash
              run: |
                  mkdir -p release-package
                  find . -maxdepth 1 -not -name '.' -not -name 'release-package' -not -name 'node_modules' -exec cp -r {} release-package/ \;

            - name: Archive release package (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  Compress-Archive -Path release-package/* -DestinationPath "${{ matrix.archive-file }}"

            - name: Archive release package (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  tar -czf "${{ matrix.archive-file }}" -C release-package .

            - name: Upload zipped artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact-name }}
                  path: ${{ matrix.archive-file }}

    release:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Read version
              id: version
              run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: binaries/

            - name: Create GitHub Release
              env:
                  GH_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
              run: |
                  gh release create "${{ steps.version.outputs.version }}" \
                    --title "${{ steps.version.outputs.version }}" \
                    --generate-notes \
                    "binaries/InjectCheatsUI-Windows/InjectCheatsUI-Windows.zip" \
                    "binaries/InjectCheatsUI-Linux/InjectCheatsUI-Linux.tar.gz" \
                    "binaries/InjectCheatsUI-macOS-x64/InjectCheatsUI-macOS-x64.tar.gz" \
                    "binaries/InjectCheatsUI-macOS-arm64/InjectCheatsUI-macOS-arm64.tar.gz"

